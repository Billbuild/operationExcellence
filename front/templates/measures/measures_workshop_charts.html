{% extends 'base/ancestor_factory_workshop.html' %}
{% load template_filters %}

<!-- 头文件，主要是 css 文件 -->
{% block head %}
<style>
    .workshop-nav {
        position: fixed;
        top: 0;
        width: 100%;
        background: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    .workshop-nav ul {
        display: flex;
        gap: 20px;
        padding: 1rem;
        margin: 0;
        list-style: none;
    }
    .workshop-nav a {
        text-decoration: none;
        color: #333;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: 0.3s;
    }
    .workshop-nav a.active {
        background: #2196F3;
        color: white;
    }

    .workshop-section {
        padding: 100px 20px 40px;
        min-height: 100vh;
    }
    .chart-container {
        {#width: 100%;#}
        height: 400px;
    }

    .chart-legend {
        margin: 10px 0;
        font-size: 14px;
    }
    .legend-item {
        display: inline-block;
        margin-right: 20px;
    }
    .legend-color {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 5px;
    }
</style>

{% endblock %}

<!-- 标题 -->
{% block title %}{% endblock %}

<!-- 内容 -->
{% block content %}
<nav class="workshop-nav">
    <ul>
        <li><a href="#section-a" class="nav-link active">A车间</a></li>
        <li><a href="#section-b" class="nav-link">B车间</a></li>
        <li><a href="#section-c" class="nav-link">C车间</a></li>
        <li><a href="#section-d" class="nav-link">D车间</a></li>
    </ul>
</nav>
<section id="section-a" class="container workshop-section">
    <h4>{{ factory }}-A车间 OWE 折线图</h4>
    <div class="chart-legend">
        <span class="legend-item">
            <span class="legend-color" style="background: #4CAF50"></span>达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background: #F44336"></span>未达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="border: 1px dashed #666"></span>目标 75%
        </span>
    </div>
    <div class="chart-container" id="chart-a"></div>
</section>
<section id="section-b" class="container workshop-section">
    <h4>{{ factory }}-B车间 OWE 折线图</h4>
    <div class="chart-legend">
        <span class="legend-item">
            <span class="legend-color" style="background: #4CAF50"></span>达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background: #F44336"></span>未达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="border: 1px dashed #666"></span>目标 75%
        </span>
    </div>
    <div class="chart-container" id="chart-b"></div>
</section>
<section id="section-c" class="container workshop-section">
    <h4>{{ factory }}-C车间 OWE 折线图</h4>
    <div class="chart-legend">
        <span class="legend-item">
            <span class="legend-color" style="background: #4CAF50"></span>达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background: #F44336"></span>未达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="border: 1px dashed #666"></span>目标 75%
        </span>
    </div>
    <div class="chart-container" id="chart-c"></div>
</section>
<section id="section-d" class="container workshop-section">
    <h4>{{ factory }}-D车间 OWE 折线图</h4>
    <div class="chart-legend">
        <span class="legend-item">
            <span class="legend-color" style="background: #4CAF50"></span>达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background: #F44336"></span>未达标
        </span>
        <span class="legend-item">
            <span class="legend-color" style="border: 1px dashed #666"></span>目标 75%
        </span>
    </div>
    <div class="chart-container" id="chart-d"></div>
</section>
{% endblock %}

<!-- 右侧侧边栏 控制栏 -->
{% block control-sidebar %}{% endblock %}

<!-- 文件末尾的 JavaScript 文件-->
{% block script %}
<script src="{% static 'adminlte/plugins/echarts/dist/echarts.min.js' %}"></script>
<script>
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetSection = document.querySelector(targetId);

        targetSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
        this.classList.add('active')
    });
});

function initChart(containerId, oweData) {
    console.log(echarts.version);
    const rawDates = {{ dates|safe }}
    const formattedDates = rawDates.map(date => {
        return date.split('-').slice(1).join('-');
    });
    {#const oweTarget = {{ owe_target }};#}
    const oweTargetList = {{ owe_target_list }};

    const chart = echarts.init(document.getElementById(containerId));
    const option = {
        tooltip: {
            trigger: 'axis',
            formatter: params => {
                const date = params[0].name;
                const actual = params[0].value;
                const target = oweTargetList[params[0].dataIndex]
                return `日期：${date}<br/>
                        实际：${(actual*100).toFixed(2)}%<br/>
                        目标：${(target*100).toFixed(2)}%`;
            }
        },
        xAxis: {
            type: 'category',
            data: formattedDates,
            axisLabel: {
                rotate: 45
            },
            name: '日期'
        },
        yAxis: {
            type: 'value'
        },
        series: [{
            name: '实际发生值',
            data: oweData,
            type: 'line',
            smooth: true,
            symbolSize: 8,
            itemStyle: {
                color: params => {
                    return params.value >= oweTargetList[params.dataIndex] ? '#4CAF50' : '#F44336'
                }
            },
            lineStyle: {
                width: 2
            }
        }, {
            name: '目标值',
            type: 'line',
            data: oweTargetList,
            symbol: 'none',
            lineStyle: {
                type: 'dashed',
                color: '#666',
                width: 1.5
            }
        }],
        grid: {
            bottom: '8%'
        }
    };
    chart.setOption(option);

    window.addEventListener('resize', () => {
        chart.resize();
    })
}

initChart('chart-a', {{ owe|safe }});
initChart('chart-b', {{ owe|safe }});
initChart('chart-c', {{ owe|safe }});
initChart('chart-d', {{ owe|safe }});

window.addEventListener('scroll', () => {
    const sections = document.querySelectorAll('.workshop-section');
    let currentSection = '';

    sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (window.scrollY >= sectionTop - 100) {
            currentSection = section.getAttribute('id');
        }
    });

    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === `#${currentSection}`)
    })
});
</script>

{% endblock %}